<!DOCTYPE html>


<html>


<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<link rel="shortcut icon" type="image/png" href="logo.png"/>
	<link rel="stylesheet" href="styles.css">

	<script type="importmap">
	  {
		"imports": {
		  "three": "https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js",
		  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.0/examples/jsm/"
		}
	  }
	</script>
</head>


<body>
	<!--div id="hud-top">
		<a href="https://github.com/boytchev/platons">
			<h1>PLATON</h1>
			<h2>Online Generator</h2>
		</a>
	</div-->
	
	<!--div id="hud-bottom">
		<image src="images/mouse.svg">
	</div-->
	
	<input id="code" type="text" value="" style="z-index:-1; position:fixed;">
	
	
	<script type="module">
		import * as THREE from "three";
		import { mergeVertices } from 'three/addons/utils/BufferGeometryUtils.js';
		import { model, canvas, HexahedronGeometry, installGui } from "./online.js";
		import { equimaterial, equitexture, noise } from "../src/texture-generator.js";


		var arrangements = [
			{geometry: THREE.TetrahedronGeometry, level: 0, maxDotSize: 9.59},

			{geometry: THREE.OctahedronGeometry, level: 0, maxDotSize: 8.76},
			{geometry: THREE.OctahedronGeometry, level: 1, maxDotSize: 7.79},

			{geometry: HexahedronGeometry, level: 0, maxDotSize: 7.40},
			{geometry: HexahedronGeometry, level: 1, maxDotSize: 6.26},
			
			{geometry: THREE.DodecahedronGeometry, level: 0, maxDotSize: 6.03},

			{geometry: THREE.IcosahedronGeometry, level: 0},
			{geometry: THREE.IcosahedronGeometry, level: 1},
			{geometry: THREE.IcosahedronGeometry, level: 2},
			{geometry: THREE.IcosahedronGeometry, level: 3},
			{geometry: THREE.IcosahedronGeometry, level: 4},
			{geometry: THREE.IcosahedronGeometry, level: 5},
		]




		var options = {
				arrangement: 7,
				color: 0x000000,
				colorThree: new THREE.Color(),
				backgroundColor: 0xFFFFFF,
				backgroundColorThree: new THREE.Color(),
				resolution: 10,
				dotSize: 2,
				sharpness: 1,
			};
			
		var guiMain = installGui( 'Polka dots', animationLoop );
		
		var gui = guiMain.addFolder( '<big>Options</big>' );
		
		
		gui.add( options, 'resolution', {'64 x 32':6, '128 x 64':7, '256 x 128':8, '512 x 256':9, '1024 x 512':10, '2048 x 1024':11, '4096 x 2048':12, '8192 x 4096':13} )
			.name( 'Resolution',  )
			.onChange( onChange );
			
		gui.add( options, 'arrangement' )
			.min(0).max(arrangements.length-1).step(1)
			.name( 'Dots <right>layout</right>',  )
			.onChange( onChange );
			
		gui.add( options, 'dotSize' )
			.min(1).max(10).step(0.01)
			.name( '<right>size</right>' )
			.onChange( onChange );
			
		gui.add( options, 'sharpness' )
			.min(0.1).max(4).step(0.1)
			.name( '<right>sharpness</right>' )
			.onChange( onChange );
			
		gui.addColor( options, 'color' )
			.name( 'Color <right>main</right>' )
			.onChange( onChange );
			
		gui.addColor( options, 'backgroundColor' )
			.name( '<right>background</right>' )
			.onChange( onChange )
			.$text.classList.add('bottom');


		// generate dot positions
		var dotPoints = [];

		for( var index in arrangements )
		{
			dotPoints[index] = [];
			
			var level = arrangements[index].level,
				geometryClass = arrangements[index].geometry;
				
			var geometry = new geometryClass(1,level);
				geometry.deleteAttribute( 'normal' );
				geometry.deleteAttribute( 'uv' );
				
			var	mergedGeometry = mergeVertices( geometry );

			var positions = mergedGeometry.getAttribute( 'position' );
			
			for( var i=0; i<positions.count; i++ )
				dotPoints[index].push( new THREE.Vector3().fromBufferAttribute( positions, i ) );
				
			geometry.dispose( );
			mergedGeometry.dispose( );
		}

		dotPoints.sort( (a,b)=>a.length-b.length );

		var vec = new THREE.Vector3();
		
		function pattern( x, y, z, color, u, v, px, py )
		{
			vec.set( z, y, x );
			
			var dist = 1e10;
			for( var point of dotPoints[options.arrangement] )
				dist = Math.min( dist, vec.distanceTo(point) );
				
			var k = THREE.MathUtils.smoothstep(
					10*dist,
					0.1*options.dotSize**2-0.1*options.sharpness,
					0.1*options.dotSize**2+0.1*options.sharpness );

		//	k = THREE.MathUtils.clamp( k, 0, 1 );
			
			color.lerpColors( options.colorThree, options.backgroundColorThree, k );
		}
		
		
		var counter = 1;
		
		function onChange( event )
		{
			counter = 1;
		
			options.colorThree.setHex( options.color );
			options.backgroundColorThree.setHex( options.backgroundColor );
			
			model.material.map = equimaterial( equitexture(pattern,2<<options.resolution,canvas, true) );
		}

		onChange( );
	
		
		var frame = 0, oldT = 0;
		function animationLoop( t )
		{
			frame++;
			
			var percent = model.material.map.update( 50 );
			model.material.map.border( 2<<(options.resolution/3) );
			
			if( percent < 1 )
			{
				if( t-oldT > 50 )
				{
					counter = Math.min( 2*counter, 128 );
				}
				
				if( frame % counter == 0 )
				{
					model.material.map.needsUpdate = true;
				}
			}

			oldT = t;
		}
		
	</script>
</body>
</html>