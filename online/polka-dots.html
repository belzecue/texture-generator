<!DOCTYPE html>


<html>


<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<link rel="shortcut icon" type="image/png" href="logo.png"/>
	<link rel="stylesheet" href="styles.css">

	<script type="importmap">
	  {
		"imports": {
		  "three": "https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js",
		  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.0/examples/jsm/"
		}
	  }
	</script>
</head>


<body>
	<!--div id="hud-top">
		<a href="https://github.com/boytchev/platons">
			<h1>PLATON</h1>
			<h2>Online Generator</h2>
		</a>
	</div-->
	
	<!--div id="hud-bottom">
		<image src="images/mouse.svg">
	</div-->
	
	<script type="module">
		import * as THREE from "three";
		import { mergeVertices } from 'three/addons/utils/BufferGeometryUtils.js';
		import { model, canvas, HexahedronGeometry, installGui } from "./online.js";
		import { equimaterial, equitexture, noise } from "../src/texture-generator.js";


		var arrangements = [
			{geometry: THREE.TetrahedronGeometry, level: 0, maxDotSize: 10.8},

			{geometry: THREE.OctahedronGeometry, level: 0, maxDotSize: 9.6},
			{geometry: THREE.OctahedronGeometry, level: 1, maxDotSize: 9.7},

			{geometry: HexahedronGeometry, level: 0, maxDotSize: 8.1},
			{geometry: HexahedronGeometry, level: 1, maxDotSize: 7.8},
			
			{geometry: THREE.DodecahedronGeometry, level: 0, maxDotSize: 8.1},

			{geometry: THREE.IcosahedronGeometry, level: 0, maxDotSize: 7.0},
			{geometry: THREE.IcosahedronGeometry, level: 1, maxDotSize: 6.2},
			{geometry: THREE.IcosahedronGeometry, level: 2, maxDotSize: 5.0},
			{geometry: THREE.IcosahedronGeometry, level: 3, maxDotSize: 4.4},
			{geometry: THREE.IcosahedronGeometry, level: 4, maxDotSize: 4.0},
			{geometry: THREE.IcosahedronGeometry, level: 5, maxDotSize: 3.6},
		]




		var guiOptions = {
				arrangement: 7,
				color: 0x000000,
				backgroundColor: 0xFFFFFF,
				resolution: 9,
				dotSize: 3,
				blur: 0.5,
			};
			
		var patternOptions = {
				color: new THREE.Color( ),
				backgroundColor: new THREE.Color( ),
				points: [],
				minDotSmooth: 0,
				maxDotSmooth: 0,
			};
			
		var guiMain = installGui( 'Polka dots' );
		
		var gui = guiMain.addFolder( '<big>Options</big>' );
		
		
		gui.add( guiOptions, 'resolution', {'256 x 128':8, '512 x 256':9, '1024 x 512':10, '2048 x 1024':11, '4096 x 2048':12, '8192 x 4096':13} )
			.name( 'Resolution',  )
			.onChange( onChange );
			
		gui.add( guiOptions, 'arrangement' )
			.min(0).max(arrangements.length-1).step(1)
			.name( 'Dots <right>layout</right>',  )
			.onChange( onChange );
			
		var guiDotSize = gui.add( guiOptions, 'dotSize' )
			.min(0.5).max(11).step(0.01)
			.name( '<right>size</right>' )
			.onChange( onChange );
			
		gui.add( guiOptions, 'blur' )
			.min(0).max(4).step(0.1)
			.name( '<right>blur</right>' )
			.onChange( onChange );
			
		gui.addColor( guiOptions, 'color' )
			.name( 'Color <right>main</right>' )
			.onChange( onChange );
			
		gui.addColor( guiOptions, 'backgroundColor' )
			.name( '<right>background</right>' )
			.onChange( onChange )
			.$text.classList.add('bottom');


		// generate dot positions
		var dotPoints = [];

		for( var index in arrangements )
		{
			dotPoints[index] = [];
			
			var level = arrangements[index].level,
				geometryClass = arrangements[index].geometry;
				
			var geometry = new geometryClass(1,level);
				geometry.deleteAttribute( 'normal' );
				geometry.deleteAttribute( 'uv' );
				
			var	mergedGeometry = mergeVertices( geometry );

			var positions = mergedGeometry.getAttribute( 'position' );
			
			for( var i=0; i<positions.count; i++ )
				dotPoints[index].push( new THREE.Vector3().fromBufferAttribute( positions, i ) );
				
			geometry.dispose( );
			mergedGeometry.dispose( );
		}

		dotPoints.sort( (a,b)=>a.length-b.length );

		var vec = new THREE.Vector3();
		
		function pattern( x, y, z, color, options, /*u, v, px, py, width, height*/ )
		{
			vec.set( z, y, x );
			
			var dist = 1e10;
			for( var point of options.points )
				dist = Math.min( dist, vec.distanceTo(point) );
				
			var k = THREE.MathUtils.smoothstep(
					dist,
					options.minDotSmooth,
					options.maxDotSmooth );
			
			color.lerpColors( options.color, options.backgroundColor, k );
		}
		
	
		function onChange( event )
		{
			var maxDotSize = arrangements[guiOptions.arrangement].maxDotSize; 
			
			guiDotSize.max( maxDotSize );
			
			if( guiOptions.dotSize > maxDotSize )
			{
				guiOptions.dotSize = maxDotSize;
			}
			guiDotSize.updateDisplay( );
			
			patternOptions.points = dotPoints[guiOptions.arrangement];
			patternOptions.color.setHex( guiOptions.color );
			patternOptions.backgroundColor.setHex( guiOptions.backgroundColor );			
			patternOptions.minDotSmooth = (guiOptions.dotSize**2-guiOptions.blur)/100;
			patternOptions.maxDotSmooth = (guiOptions.dotSize**2+guiOptions.blur)/100;
			
			model.material.map = equimaterial( equitexture(pattern,2<<guiOptions.resolution,canvas, true, patternOptions) );
		}

		onChange( );

		
	</script>
</body>
</html>